<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Details - GameVerse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* CSS cho star rating */
    .star-rating {
      display: inline-flex;
      align-items: center;
      gap: 4px; /* khoảng cách giữa các sao */
    }

    .star-rating svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .star-full {
      color: #facc15; /* yellow-400 */
    }

    .star-empty {
      color: #6b7280; /* gray-500 */
    }

    .star-score {
      margin-left: 8px;
      font-weight: 600;
      color: #facc15;
      font-size: 1rem;
      min-width: 32px;
      text-align: left;
      user-select: none;
    }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">
  <!-- Navbar -->
  <nav class="bg-gray-800 p-4 w-full z-10 relative">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl text-indigo-400 font-semibold">GameVerse</h1>
      <div class="flex space-x-4">
        <a href="index.html" class="text-indigo-400 hover:text-indigo-600 transition">Home</a>
        <a href="gamelist.html" class="text-indigo-400 hover:text-indigo-600 transition">Games</a>
        <a href="wishlist.html" class="text-indigo-400 hover:text-indigo-600 transition">Wishlist</a>
      </div>
      <div id="accountSection" class="flex items-center space-x-4">
        <button id="loginBtn" class="text-indigo-400 hover:text-indigo-600 transition">Login</button>
        <div id="userSection" class="hidden space-x-4">
          <span id="userName" class="text-gray-400">Welcome, User!</span>
          <button id="logoutBtn" class="text-indigo-400 hover:text-indigo-600 transition">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Game Details Section -->
  <div class="p-8 w-full max-w-7xl mx-auto mt-12">
    <button id="backBtn"
      class="bg-indigo-500 text-white px-6 py-3 rounded-full text-lg hover:bg-indigo-600 transition mb-8">
      ← Back to Game List
    </button>

    <div id="gameDetails" class="bg-gray-800 p-8 rounded-2xl shadow-lg">
      <!-- Game details sẽ được insert vào đây -->
    </div>

    <button id="addToWishlistBtn"
      class="bg-green-500 text-white px-6 py-3 rounded-full text-lg hover:bg-green-600 transition mt-4">
      Add to Wishlist
    </button>
  </div>

  <!-- Toast Notification -->
  <div id="toast"
    class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
    Added to wishlist!
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBRT5VFIn2NGVzNn15mu_YeQNiz8vEmiL0",
      authDomain: "game-verse-c777c.firebaseapp.com",
      projectId: "game-verse-c777c",
      storageBucket: "game-verse-c777c.appspot.com",
      messagingSenderId: "413081788819",
      appId: "1:413081788819:web:e9d1ee9d2be5eb37230866",
      measurementId: "G-DF5HFT1R49"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("userName").textContent = `Welcome, ${user.email}`;
        document.getElementById("userSection").classList.remove("hidden");
        document.getElementById("loginBtn").classList.add("hidden");
      } else {
        document.getElementById("userSection").classList.add("hidden");
        document.getElementById("loginBtn").classList.remove("hidden");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      }).catch(error => console.error("Logout error:", error));
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      window.history.back();
    });

    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');
    const API_KEY = 'd81ce92c1bcd4d74bba38ee005e26d8c';

    async function fetchGameDetails(id) {
      try {
        const response = await fetch(`https://api.rawg.io/api/games/${id}?key=${API_KEY}`);
        if (!response.ok) throw new Error("API Error");
        const game = await response.json();

        document.getElementById("gameDetails").innerHTML = `
          <div class="flex flex-col md:flex-row items-start gap-8">
            <div class="w-full md:w-1/2">
              <img src="${game.background_image || 'https://via.placeholder.com/600'}" alt="${game.name}" class="rounded-xl shadow-lg w-full max-h-[500px] object-cover mb-4" />
              <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg text-indigo-300 font-semibold mb-2">PC Requirements</h3>
                <ul class="text-sm list-disc list-inside text-gray-300 space-y-1">
                  <li><strong>Minimum:</strong> ${getRequirementText(game.platforms, 'minimum')}</li>
                  <li><strong>Recommended:</strong> ${getRequirementText(game.platforms, 'recommended')}</li>
                </ul>
              </div>
            </div>
            <div class="w-full md:w-1/2">
              <div class="bg-gray-700 p-6 rounded-lg space-y-4">
                <h2 class="text-4xl font-bold text-indigo-400">${game.name}</h2>
                <div>${getStarRating(game.rating)}</div>
                <p><span class="font-semibold text-gray-400">Release Date:</span> ${game.released}</p>
                <p><span class="font-semibold text-gray-400">Developer:</span> ${game.developers?.map(d => d.name).join(', ') || 'Unknown'}</p>
                <p><span class="font-semibold text-gray-400">Genres:</span> ${game.genres.map(g => g.name).join(', ')}</p>
                <p><span class="font-semibold text-gray-400">Platforms:</span> ${game.platforms.map(p => p.platform.name).join(', ')}</p>
                <div class="text-gray-300 text-justify leading-relaxed">${game.description_raw || 'No description available.'}</div>
                ${game.website ? `<a href="${game.website}" target="_blank" class="inline-block mt-4 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-full transition">Visit Game Website</a>` : ''}
              </div>
            </div>
          </div>
        `;

        // Add to Wishlist button
        document.getElementById("addToWishlistBtn").addEventListener("click", () => {
          const gameData = {
            id: game.id,
            name: game.name,
            background_image: game.background_image || 'https://via.placeholder.com/600',
            released: game.released,
            description_raw: game.description_raw,
            rating: game.rating,
          };

          let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
          if (!wishlist.some(item => item.id === gameData.id)) {
            wishlist.push(gameData);
            localStorage.setItem("wishlist", JSON.stringify(wishlist));
            showToast(`${gameData.name} has been added to your wishlist!`);
          } else {
            showToast(`${gameData.name} is already in your wishlist.`);
          }
        });
      } catch (err) {
        console.error("Failed to load game:", err);
        document.getElementById("gameDetails").innerHTML = `<p class="text-red-400">Error loading game details.</p>`;
      }
    }

    if (gameId) fetchGameDetails(gameId);
    else document.getElementById("gameDetails").innerHTML = `<p class="text-red-400">No game ID provided.</p>`;

    function getStarRating(rating) {
      const starsTotal = 5;
      const fullStars = Math.floor(rating);
      const halfStar = (rating - fullStars) >= 0.5 ? 1 : 0;
      const emptyStars = starsTotal - fullStars - halfStar;

      const starFull = `<svg xmlns="http://www.w3.org/2000/svg" class="star-full" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;

      const starHalf = `<svg xmlns="http://www.w3.org/2000/svg" class="star-full" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <defs>
          <linearGradient id="halfGrad" x1="0" y1="0" x2="1" y2="0">
            <stop offset="50%" stop-color="currentColor" />
            <stop offset="50%" stop-color="transparent" />
          </linearGradient>
        </defs>
        <path fill="url(#halfGrad)" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2V17.27z"/>
        <path fill="none" stroke="currentColor" stroke-width="2" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
      </svg>`;

      const starEmpty = `<svg xmlns="http://www.w3.org/2000/svg" class="star-empty" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linejoin="round" stroke-linecap="round" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;

      return `
        <div class="star-rating" aria-label="Rating: ${rating.toFixed(1)} out of 5 stars" role="img">
          ${starFull.repeat(fullStars)}
          ${halfStar ? starHalf : ''}
          ${starEmpty.repeat(emptyStars)}
          <span class="star-score">${rating.toFixed(1)}</span>
        </div>
      `;
    }

    function getRequirementText(platforms, type) {
      for (const item of platforms) {
        const reqs = item.requirements;
        if (reqs && reqs[type]) return reqs[type];
      }
      return 'Not available';
    }

    // Show toast notification
    function showToast(message, duration = 2000) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.remove("opacity-0");
      toast.classList.add("opacity-100");

      setTimeout(() => {
        toast.classList.remove("opacity-100");
        toast.classList.add("opacity-0");
      }, duration);
    }
  </script>
</body>

</html>
